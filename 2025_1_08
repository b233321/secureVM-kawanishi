AMD64 Architecture Programmer's Manual Volume 2:System Programming
15.35

sev対応の仮想マシンはsev-esでハイパバイザからゲストレジスタの状態を保護
sev-es仮想マシンのcpuレジスタの状態はワールドスイッチ時に暗号化→ハイパバイザから直接アクセスや変更できない
↓
仮想マシン状態の不正読み取り
ロールバック攻撃(以前の仮想マシンレジスタの復元)を含むフロー攻撃(仮想マシン状態の変更)
以上からの保護

sev-es
デフォルトでゲスト仮想マシンの登録状態保護
ゲスト仮想マシン自体がアクセス許可をする
↑
(#VMEXIT)→全ての仮想マシン登録状態保存されて暗号化→VMRUNでのみ複合化

sev-esでは#vmexitは自動出口(AE)か非自動出口(NAE)に分類
ae:gessuto実行に関して非同期に発生する割込み等やゲストレジスタの状態を公開する必要のないイベント
nae:ae以外。ゲストはGHCBで公開するレジスタ状態を決定

VMGEXIT
AEを生成し、ゲスト#VCハンドラが必要に応じてハイパバイザを呼び出す

GHCB
sev-esゲストとハイパバイザ間でレジスタ状態を通信するための暗号化されていないメモリページ
ゲスト仮想マシンはGHCB MSR(C001_0130)を介してGHCBの場所を設定
MSRの値は0A0hから保存、復元
GHCB MSRはゲストモードでのみ読み取り、書き込み可能。ホストモードでアクセスすると#GB発生
ハードウェアはGHCBに直接アクセスしないから、GHCBの形式は固定されていない

sev-es有効時仮想マシンの保存領域はVMCBページのオフセット400hに存在しない→VMSAにある
ハードウェアはゲストの暗号鍵で暗号化されたメモリアクセスを使用してVMSA保存領域にアクセス
ハードウェアVMRUN実行
↓
vmcb「このゲストsev-es有効」
↓
ハードウェアはvmsaポインタ(vmsaのアドレス)から暗号化された保存領域からゲストの状態をロード

sev-es対応ゲストの実行中に自動終了イベントが発生すると、ハードウェアはゲストの状態を暗号化された保存領域に自動保存
↓
ホストの保存領域からハイパバイザの状態復元





ワールドスイッチ
ae:ゲストレジスタの状態を公開する必要無し
レジスタの状態が必要なときだけ手動で公開?非自動だから,GHCBで公開する登録状態を制御?

ゲストハイパバイザ通信block(GHCB)
guestとハイパバイザが通信できるようにできるように→guestによって暗号解除されてマップされる
GHCB()4KBのサイズと定義、復号化された一つのページに含める
